# DeployScript - Инструмент автоматического развёртывания микросервисов

DeployScript - это инструмент на Go для автоматизации развёртывания множества микросервисов с поддержкой сборки Maven, операций Git и интеграции с GitLab CI/CD.

## Возможности

- **Развёртывание множества сервисов**: Развёртывание нескольких сервисов, определённых в YAML конфигурации
- **Последовательное и параллельное выполнение**: Поддержка как последовательного, так и группового параллельного развёртывания
- **Автоматизация Git**: Автоматическое создание веток, тегов и отправка изменений
- **Интеграция с Maven**: Автоматическое обновление версий в POM файлах и сборка
- **GitLab CI/CD**: Автоматическое создание и мониторинг пайплайнов
- **Генерация release notes**: Автоматическая генерация заметок о релизе с отслеживанием задач
- **Проверки безопасности**: Валидация рабочих директорий Git перед развёртыванием

## Требования

- Go 1.23 или выше
- Git
- Maven
- Доступ к GitLab с валидным API токеном
- Правильно настроенный файл `deploy.yaml`

## Установка

```bash
go build -o deploy
```

## Конфигурация

### Переменные окружения

- `GITLAB_TOKEN` (обязательно): API токен GitLab для создания пайплайнов
- `GITLAB_URI` (обязательно): URL GitLab инстанса (например, `https://gitlab.company.com`)
- `M2_REPO` (опционально): Расположение Maven репозитория (по умолчанию `~/.m2/repository`)

### Структура deploy.yaml

```yaml
task_url_prefix: "https://jira.company.com/browse/"

# Сервисы, которые должны развёртываться последовательно
sequential:
  - name: "core-service"
    directory: "core"
    gitlab_project: "team/core-service"
  - name: "api-gateway"
    directory: "gateway"
    gitlab_project: "team/api-gateway"

# Сервисы, которые могут развёртываться параллельно внутри своих групп
groups:
  backend:
    - name: "user-service"
      directory: "services/user"
      gitlab_project: "team/user-service"
    - name: "order-service"
      directory: "services/order"
      gitlab_project: "team/order-service"
  
  frontend:
    - name: "web-app"
      directory: "apps/web"
      gitlab_project: "team/web-app"
    - name: "mobile-app"
      directory: "apps/mobile"
      gitlab_project: "team/mobile-app"
```

### Поля конфигурации сервиса

- `name`: Отображаемое имя сервиса
- `directory`: Относительный путь к директории сервиса от базовой директории
- `gitlab_project`: Путь проекта в GitLab (namespace/project-name)

## Использование

### Базовая команда

```bash
./deploy -directory /path/to/services -version 123
```

### С указанием namespace

```bash
./deploy -directory /path/to/services -version 123 -namespace production
```

### Короткая форма

```bash
./deploy -d /path/to/services -v 123
```

### Параметры командной строки

- `-directory`, `-d` (обязательно): Базовая директория, содержащая все директории сервисов
- `-version`, `-v` (обязательно): Номер версии для развёртывания (должен быть целым числом)
- `-namespace` (опционально): Helm namespace для развёртывания
- `-h`: Показать справочную информацию

## Процесс развёртывания

Развёртывание проходит следующие фазы:

### Фаза 1: Проверка статуса Git
- Проверяет, что все директории сервисов имеют чистые рабочие копии
- Предлагает очистку, если найдены незакоммиченные изменения

### Фаза 2: Переключение веток
- Переключает все сервисы на ветку `develop`

### Фаза 3: Получение последних изменений
- Выполняет pull последних изменений из удалённого репозитория для всех сервисов

### Фаза 4: Обновление POM файлов
- Обновляет версию во всех файлах `pom.xml` на `{version}.0`
- Обновляет версии parent в подмодулях
- Обновляет свойства, содержащие "proezd" в названии

### Фаза 5: Создание релизных веток
- Создаёт ветку `release/{version}` для всех сервисов
- Удаляет существующие ветки, если они есть (локально и удалённо)

### Фаза 5.1: Генерация Release Notes
- Сравнивает с предыдущей релизной веткой
- Извлекает ID задач из сообщений коммитов (формат: `TASK-12345`)
- Создаёт файл `release-notes-{version}.txt` содержащий:
    - Список новых задач, включённых в релиз
    - Статистику по сервисам
    - Ссылки на систему отслеживания задач (если настроено)

### Фаза 6: Коммит изменений
- Добавляет все изменения в индекс
- Создаёт коммит с сообщением: "Up to version {version}.0"

### Фаза 7: Создание тегов
- Создаёт тег `release/{version}.0` для всех сервисов
- Удаляет существующие теги, если они есть

### Фаза 8: Сборка Maven
- Очищает кеш Maven для артефактов проекта
- Собирает все сервисы последовательно с помощью `mvn clean install`
- Показывает вывод сборки в реальном времени

### Фаза 9: Отправка изменений
- Отправляет ветки и теги в удалённый репозиторий
- Использует `--force-with-lease` для безопасности

### Фаза 10: Создание пайплайнов GitLab
- Создаёт пайплайны для всех сервисов согласно конфигурации
- Последовательные сервисы развёртываются один за другим
- Групповые сервисы развёртываются параллельно внутри своих групп
- Мониторит выполнение пайплайнов и сообщает о статусе

## Порядок выполнения

1. **Последовательные сервисы**: Развёртываются один за другим в указанном порядке
2. **Групповые сервисы**: Каждая группа обрабатывается последовательно, но сервисы внутри группы запускаются параллельно

Пример порядка выполнения для конфигурации выше:
1. core-service (ожидает завершения)
2. api-gateway (ожидает завершения)
3. Группа backend: user-service и order-service (параллельно)
4. Группа frontend: web-app и mobile-app (параллельно)

## Release Notes

Инструмент автоматически генерирует заметки о релизе путём:
- Поиска предыдущей релизной ветки (`release/{version-1}`)
- Сравнения коммитов между релизами
- Извлечения ID задач из сообщений коммитов
- Фильтрации задач, которые уже были в предыдущем релизе

Формат ID задач: 2-10 букв, дефис и 5-6 цифр (например, `JIRA-12345`, `TASK-567890`)

## Обработка ошибок

- **Незакоммиченные изменения**: Предлагает очистку или отмену
- **Отсутствующие директории**: Завершается с понятным сообщением об ошибке
- **Ошибки сборки**: Останавливает развёртывание и показывает вывод Maven
- **Ошибки пайплайнов**: Сообщает о проблемном сервисе и останавливает развёртывание
- **Проблемы с сетью**: Таймаут через 60 минут при мониторинге пайплайнов

## Лучшие практики

1. **Всегда запускайте из чистого окружения**: Убедитесь в отсутствии локальных изменений перед развёртыванием
2. **Тестируйте конфигурацию**: Проверяйте `deploy.yaml` перед запуском развёртывания
3. **Мониторьте пайплайны**: Проверяйте интерфейс GitLab для детальных логов пайплайнов
4. **Нумерация версий**: Используйте последовательные целые числа для версий
5. **Резервные копии**: Рассмотрите создание резервных копий текущего состояния перед крупными развёртываниями

## Устранение неполадок

### Не установлен GITLAB_TOKEN
```bash
export GITLAB_TOKEN="ваш-gitlab-токен"
export GITLAB_URI="https://gitlab.company.com"
```

### Ошибки сборки Maven
- Проверьте настройки Maven
- Убедитесь, что все зависимости доступны
- Проверьте логи сборки на наличие конкретных ошибок

### Директория не существует
- Убедитесь, что базовая директория существует
- Проверьте, что все директории сервисов присутствуют относительно базовой директории

### Пайплайны не запускаются
- Проверьте права доступа API токена
- Убедитесь, что пути проектов в GitLab корректны
- Проверьте наличие `.gitlab-ci.yml` в репозиториях

### Ошибка "working directory has uncommitted changes"
- Выполните `git status` в проблемной директории
- Закоммитьте или откатите изменения
- Или позвольте инструменту очистить директорию автоматически

## Пример полного цикла развёртывания

```bash
# Установка переменных окружения
export GITLAB_TOKEN="glpat-xxxxxxxxxxxx"
export GITLAB_URI="https://gitlab.company.com"

# Запуск развёртывания версии 150 в production namespace
./deploy -directory /home/user/microservices -version 150 -namespace production

# Инструмент выполнит:
# 1. Проверку чистоты репозиториев
# 2. Переключение на develop и обновление
# 3. Изменение версий на 150.0
# 4. Создание веток release/150
# 5. Генерацию release-notes-150.txt
# 6. Коммит и тегирование release/150.0
# 7. Сборку всех сервисов
# 8. Отправку изменений в GitLab
# 9. Запуск пайплайнов развёртывания
```

## Структура проекта

```
deploy/
├── main.go           # Основная логика приложения
├── deploy.yaml       # Конфигурация сервисов
├── config/
│   └── config.go     # Парсинг и работа с конфигурацией
├── git/
│   └── git.go        # Git операции и генерация release notes
├── gitlab/
│   └── gitlab.go     # Взаимодействие с GitLab API
├── maven/
│   └── maven.go      # Maven операции и обновление POM файлов
└── go.mod            # Go модуль
